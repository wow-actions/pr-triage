name: PR Triage
on:
  pull_request_target:
    types: [opened, closed, edited, reopened, synchronize, ready_for_review]
  pull_request_review:
    types: [submitted, dismissed]
  repository_dispatch:
    types: [pr-triage-on-pull-request-review]

jobs:
  triage:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'pull_request_target' || github.event_name == 'repository_dispatch' }}
    steps:
      - uses: actions/checkout@v2
      - name: ðŸš§ã€€Install
        run: yarn
      - name: ðŸ“¦ã€€Build
        run: yarn build
      - uses: ./
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN  }}

  dummy:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'pull_request_review' }}
    steps:
      - name: Tips
        run: echo "this is a dummy job that dispatch a repository event; it's necessary because otherwise the repo secrets will not be in scope for externally forked pull requests"
      - name: ðŸ”€ã€€Repository Dispatch
        uses: peter-evans/repository-dispatch@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN  }}
          event-type: pr-triage-on-pull-request-review
          client-payload: '{"sha": "${{ github.sha }}"}'
